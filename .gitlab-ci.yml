stages: [baremetal-config, validate, build, deploy, configure, cleanup]

variables:
    GITLAB_TOFU_ROOT_DIR: terraform/dev/

include:
  - component: $CI_SERVER_FQDN/components/opentofu/job-templates@0.48.0
    inputs:
      version: 0.48.0

.ansible:
  image: alpine:3.20
  stage: configure
  variables:
    ANSIBLE_HOST_KEY_CHECKING: False
    ANSIBLE_CONFIG: ansible.cfg
  before_script:
    - apk add --no-cache ansible bash openssh-client rsync
    - mkdir -p ~/.ssh
    - echo $ANSIBLE_PRIVATE_KEY | base64 -d >> ~/.ssh/id_ed25519 && chmod '600' ~/.ssh/id_ed25519
    - cd ansible
  script:
    - ansible-playbook -i $INVENTORY --extra-vars "environment_name=$ENVIRONMENT_NAME" $PLAYBOOK
#tofu fmt baremetal:
#  stage: baremetal-config
#  extends: [.opentofu:fmt]
#
#tofu validate baremetal:
#  stage: baremetal-config
#  extends: [.opentofu:validate]
#  needs: ['tofu fmt baremetal']
#
#tofu plan baremetal:
#  stage: baremetal-config
#  extends: [.opentofu:plan]
#  needs: ['tofu validate baremetal']
#
#tofu apply baremetal:
#  stage: baremetal-config
#  extends: [.opentofu:apply]
#  needs: ['tofu plan baremetal']

ansible bare metal:
  stage: baremetal-config
  #  needs: ['tofu apply baremetal']
  extends: .ansible
  variables:
    INVENTORY: inventory_bare_metal.config
    ENVIRONMENT_NAME: baremetal
  parallel:
    matrix:
      - PLAYBOOK: ['proxmox.yml']
  rules:
    - if: $CI_COMMIT_TAG

#ansible gitlab:
#  stage: baremetal-config
#  needs: ['ansible bare metal']
#  extends: .ansible
#  variables:
#    INVENTORY: inventory_gitlab.config
#    ENVIRONMENT_NAME: gitlab
#  parallel:
#    matrix:
#      - PLAYBOOK: ['gitlab.yml', 'gitlab-runner.yml']
#  rules:
#    - if: $CI_COMMIT_TAG

tofu fmt:
  extends: [.opentofu:fmt]

tofu validate:
  extends: [.opentofu:validate]

tofu plan dev:
  extends: [.opentofu:plan]
  variables:
    GITLAB_TOFU_STATE_NAME: dev
    GITLAB_TOFU_VAR_FILE: dev.tfvars
    GITLAB_TOFU_ROOT_DIR: terraform/dev/
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - when: on_success

tofu plan prod:
  extends: [.opentofu:plan]
  variables:
    GITLAB_TOFU_STATE_NAME: prod
    GITLAB_TOFU_VAR_FILE: prod.tfvars
  rules:
    - if: $CI_COMMIT_TAG

#tofu apply dev:
#  extends: [.opentofu:apply]
#  variables:
#    GITLAB_TOFU_STATE_NAME: dev
#    GITLAB_TOFU_VAR_FILE: dev.tfvars
#  rules:
#    - if: $CI_COMMIT_TAG
#      when: never
#    - when: on_success
#
#tofu apply prod:
#  extends: [.opentofu:apply]
#  variables:
#    GITLAB_TOFU_STATE_NAME: prod
#    GITLAB_TOFU_VAR_FILE: prod.tfvars
#  rules:
#    - if: $CI_COMMIT_TAG
#
#ansible VM dev:
#  extends: .ansible
#  variables:
#    INVENTORY: inventory_VMs.config
#    ENVIRONMENT_NAME: dev
#  parallel:
#    matrix:
#      - PLAYBOOK: ['alma-linux-9.yml']
#  rules:
#    - if: $CI_COMMIT_TAG
#      when: never
#    - when: on_success
#
#ansible VM prod:
#  extends: .ansible
#  variables:
#    INVENTORY: inventory_VMs.config
#    ENVIRONMENT_NAME: prod
#  parallel:
#    matrix:
#      - PLAYBOOK: ['alma-linux-9.yml']
#  rules:
#    - if: $CI_COMMIT_TAG
#
#tofu destroy dev:
#  extends: [.opentofu:destroy]
#  variables:
#    GITLAB_TOFU_PLAN_NAME: dev
#  rules:
#    - if: $CI_COMMIT_TAG
#      when: never
#    - when: manual
