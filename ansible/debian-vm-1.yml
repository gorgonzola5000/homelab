---
# TODO
# move wireguard_server here
# move debian here instead of being a role
- name: Configure Debian VM
  become: true
  #  hosts: "{{ variable_host | default('debian') }}"
  hosts: '{{ target | default("default") }}'
  #  hosts: default
  remote_user: root
  roles:
    - debian
    - common
    - vm
    - wireguard_server
    - role: nginx_reverse_proxy
      vars:
        nginx_config_files_directory: ./config_files/debian-vm-1/etc/nginx/
        domains:
          - home.parents-basement.win
          - '*.home.parents-basement.win'
        sites_to_enable:
          - home.parents-basement.win
  tasks:
    - name: Install Podman
      ansible.builtin.package:
        name: podman
        state: present
    # 
    # Pi-hole
    - name: Create Pi-Hole user
      ansible.builtin.user:
        name: pihole
        shell: '/bin/bash'
        create_home: true
    - name: Ensure directory for pihole is present
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: pihole
        group: pihole
        mode: '0755'
      loop:
        - '/home/pihole/etc/pihole'
        - '/home/pihole/etc/dnsmasq.d'
    - name: Disable systemd-resolved
      ansible.builtin.systemd_service:
        name: systemd-resolved
        state: stopped
        enabled: false
    - name: Run Pi-hole container
      containers.podman.podman_container:
        name: pihole
        image: docker.io/pihole/pihole:latest
        hostname: pi-hole
        state: started
        ports:
          - "53:53/tcp"
          - "53:53/udp"
          - "50001:80/tcp"
        volumes:
          - "/home/pihole/etc/pihole:/etc/pihole"
          - "/home/pihole/etc/dnsmasq.d:/etc/dnsmasq.d"
        env:
          TZ: "Europe/Warsaw"
          WEBPASSWORD: "{{ vault_pihole_web_password }}"
    # 
    # ddclient
    - name: Create ddclient user
      ansible.builtin.user:
        name: ddclient
        shell: '/bin/bash'
        create_home: true
    - name: Ensure directory for ddclient is present
      ansible.builtin.file:
        path: /home/ddclient/config
        state: directory
        owner: ddclient
        group: ddclient
        mode: '0755'
    - name: Copy ddclient file
      ansible.builtin.copy:
        src: ./config_files/debian-vm-1/home/ddclient/config/ddclient.conf 
        dest: /home/ddclient/config/ddclient.conf
        owner: ddclient
        group: ddclient
        mode: '0644'
    - name: Run ddclient container
      containers.podman.podman_container:
        name: ddclient
        image: docker.io/linuxserver/ddclient:latest
        hostname: ddclient
        state: started
        volumes:
          - "/home/ddclient/config:/config"
        env:
          TZ: "Europe/Warsaw"
          DDCLIENT_PASSWORD: "{{ vault_ddclient_cloudflare_token }}"

  post_tasks:
    - name: Set resolv.conf
      ansible.builtin.copy:
        dest: /etc/resolv.conf
        content: nameserver 10.2.137.1
