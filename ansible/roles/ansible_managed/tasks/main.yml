---
- name: Ensure sudo is installed
  ansible.builtin.package:
    name: sudo
    state: present

- name: Ensure group sudo exists
  ansible.builtin.group:
    name: sudo
    state: present

- name: Ensure passwordless sudo for user ansible
  ansible.builtin.copy:
    dest: /etc/sudoers.d/ansible.conf
    content: 'ansible ALL=(ALL) NOPASSWD:ALL'
    mode: '0644'
    owner: root
    group: root
  notify: restart sshd

- name: Ensure user ansible is present
  ansible.builtin.user:
    name: ansible
    create_home: true
    groups: sudo
    append: true
  notify: restart sshd

- name: Ensure public key is present in authorized_keys for user ansible
  ansible.posix.authorized_key:
    user: ansible
    state: present
    key: "{{ vault_ansible_public_key }}"
  notify: restart sshd
